This is an experiment to implement the BLS12-381 pairing operation in EVM with the proposed EVM384 extension (three new opcodes: `ADDMOD384`, `SUBMOD384`, `MULMODMONT384`). Feedback and discussion occurs on Ethereum AllCoreDevs chat, AllCoreDevs calls, and on [this discussion thread](https://ethereum-magicians.org/t/evm384-feedback-and-discussion/4533).


## Files

```
genhuff.py		 includes all cryptography, based off the blst algorithms, outputs huff file

bls12_381.huff		 various huff modules generated by genhuff.py
main.huff		 huff file which selects which modules in BLS12_381.huff to assemble with huff, plus some basic memory setup and i/o
miller_loop.hex		 EVM bytecode generated from main.huff module MILLER_LOOP_CONTRACT
final_exponentiation.hex EVM bytecode generated from main.huff module FINAL_EXPONENTIATION_CONTRACT
inversemod_bls12381.huff included in bls12_381.huff, implements field inversemod with respect to the BLS12-381 prime; to generate this file: https://gist.github.com/poemm/52653a344528278f09403354569d0855

compile.js               calls the huff compiler on main.huff
huff.patch               patch to tell huff how to handle EVM384 opcodes
```


## Generate EVM bytecode

Get these files.

```
git clone https://github.com/poemm/EVMcurves
cd EVMcurves
```

Get huff. Note: we put huff inside directory `EVMcurves/` because the path to huff is hardcoded in `compile.js`.

```
git clone https://github.com/AztecProtocol/huff.git
```

Patch huff with new EVM384 opcodes.

```
# this patch was generated with: diff -ruN huff huff_modified > huff.patch
patch -s -p0 < huff.patch
```

Set up huff. Note: This will get dependencies listed in `huff/package.json`. Don't worry, everything is put in the local directory `node_modules/`. And npm caches packages in `/home/<user>/.npm` which can be removed with `npm cache clean`.

```
cd huff
npm install
cd ..
```

Finally generate the EVM bytecode for the Miller loop and final exponentiation, with huff as an intermediate step.

```
python3 genhuff.py > bls12_381.huff
node compile.js MILLER_LOOP_CONTRACT > miller_loop.hex
node compile.js FINAL_EXPONENTIATION_CONTRACT > final_exponentiation.hex
```

Edit `genhuff.py` or `main.huff` to generate custom crypto.



## TODO

- BLS12-381
  - Subgroup checks for each group
  - EC add, EC mul, multi-exponentiation for each group
  - Hash to curve for each group
  - Pairing equation check with a variable number of pairings
- Other pairings, e.g. BN128 and BLS12-377
- ECDSA and EdDSA e.g. secp256k1
- Algebraic hashing e.g. Pedersen hashing
- Polynomial evaluation e.g. STARK verifiers
- Other crypto primitives
- Other Cryptosystems

